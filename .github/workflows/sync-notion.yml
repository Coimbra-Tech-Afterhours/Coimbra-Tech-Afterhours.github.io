# Sync events from Notion database to static JSON file
#
# Setup required secrets in GitHub:
#   1. Go to: Settings → Secrets and variables → Actions
#   2. Add the following repository secrets:
#      - NOTION_API_KEY: Your Notion integration API key
#      - NOTION_EVENTS_DATABASE: The ID of your Events database
#      - NOTION_PLACES_DATABASE: (Optional) The ID of your Places database
#
# This workflow runs hourly (UTC) and can be triggered manually via workflow_dispatch

name: Sync from Notion

on:
  schedule:
    - cron: "0 * * * *"   # hourly, UTC (checks for updates)
    - cron: "0 0 * * *"   # daily at midnight UTC (ensures date-based status updates)
  workflow_dispatch:

permissions:
  contents: write
  actions: write  # Required to trigger other workflows via workflow_dispatch

concurrency:
  group: sync-notion
  cancel-in-progress: true

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          persist-credentials: true

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: |
          if [ -f package-lock.json ]; then
            npm ci
          else
            npm install
          fi

      - name: Ensure public directory exists (if script writes there)
        run: mkdir -p public

      - name: Check if Notion database was updated
        id: check_updates
        env:
          NOTION_API_KEY: ${{ secrets.NOTION_API_KEY }}
          NOTION_EVENTS_DATABASE: ${{ secrets.NOTION_EVENTS_DATABASE }}
        run: |
          if node scripts/check-notion-updates.mjs; then
            echo "fetch_needed=true" >> $GITHUB_OUTPUT
          else
            echo "fetch_needed=false" >> $GITHUB_OUTPUT
          fi
        continue-on-error: true

      - name: Fetch events from Notion
        if: steps.check_updates.outputs.fetch_needed == 'true'
        id: fetch_events
        env:
          NOTION_API_KEY: ${{ secrets.NOTION_API_KEY }}
          NOTION_EVENTS_DATABASE: ${{ secrets.NOTION_EVENTS_DATABASE }}
          NOTION_PLACES_DATABASE: ${{ secrets.NOTION_PLACES_DATABASE }}
        run: |
          if ! node scripts/fetch-events-from-notion.mjs; then
            echo "Failed to fetch events from Notion"
            exit 1
          fi
          echo "Events fetched successfully"

      - name: Commit & push if changed
        id: commit_push
        run: |
          # Check if there are any changes
          if [ -z "$(git status --porcelain)" ]; then
            echo "No changes to commit."
            echo "changes_committed=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # Configure git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Check if only .last-sync changed (no actual data changes)
          CHANGED_FILES=$(git status --porcelain | awk '{print $2}')
          ONLY_SYNC_FILE=true
          DATA_CHANGED=false
          
          for file in $CHANGED_FILES; do
            if [ "$file" != ".last-sync" ]; then
              ONLY_SYNC_FILE=false
              # Check if events.json or other data files changed
              if [[ "$file" == "public/events.json" ]] || [[ "$file" == "public/"* ]]; then
                DATA_CHANGED=true
              fi
              break
            fi
          done
          
          if [ "$ONLY_SYNC_FILE" = true ]; then
            echo "Only .last-sync changed, committing timestamp update..."
            git add .last-sync
            git commit -m "chore(sync): update last sync timestamp"
            echo "commit_message=chore(sync): update last sync timestamp" >> $GITHUB_OUTPUT
            echo "data_changed=false" >> $GITHUB_OUTPUT
          else
            echo "Data changes detected, committing updates..."
            git add -A
            if [ "$DATA_CHANGED" = true ]; then
              git commit -m "chore(data): update events from Notion"
              echo "commit_message=chore(data): update events from Notion" >> $GITHUB_OUTPUT
              echo "data_changed=true" >> $GITHUB_OUTPUT
            else
              git commit -m "chore: update files from Notion sync"
              echo "commit_message=chore: update files from Notion sync" >> $GITHUB_OUTPUT
              echo "data_changed=false" >> $GITHUB_OUTPUT
            fi
          fi
          
          # Push changes
          if ! git push; then
            echo "Failed to push changes"
            exit 1
          fi
          
          echo "changes_committed=true" >> $GITHUB_OUTPUT
          echo "Changes committed and pushed successfully"

      - name: Trigger deployment workflow
        if: steps.commit_push.outputs.changes_committed == 'true' && steps.commit_push.outputs.data_changed == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            // Trigger the deployment workflow via workflow_dispatch
            // This ensures the deployment runs immediately after sync completes
            try {
              await github.rest.actions.createWorkflowDispatch({
                owner: context.repo.owner,
                repo: context.repo.repo,
                workflow_id: 'static.yml',
                ref: 'main'
              });
              console.log('✅ Deployment workflow triggered successfully');
            } catch (error) {
              console.error('❌ Failed to trigger deployment workflow:', error.message);
              // Fail the step if we can't trigger deployment
              // This ensures we know if deployment isn't happening
              throw error;
            }

