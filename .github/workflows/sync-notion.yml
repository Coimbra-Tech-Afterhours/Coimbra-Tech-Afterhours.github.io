# Sync events from Notion database to static JSON file
#
# Setup required secrets in GitHub:
#   1. Go to: Settings → Secrets and variables → Actions
#   2. Add the following repository secrets:
#      - NOTION_API_KEY: Your Notion integration API key
#      - NOTION_EVENTS_DATABASE: The ID of your Events database
#      - NOTION_PLACES_DATABASE: (Optional) The ID of your Places database
#
# This workflow runs hourly (UTC) and can be triggered manually via workflow_dispatch

name: Sync from Notion

on:
  schedule:
    - cron: "0 * * * *"   # hourly, UTC
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: sync-notion
  cancel-in-progress: true

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          persist-credentials: true

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: |
          if [ -f package-lock.json ]; then
            npm ci
          else
            npm install
          fi

      - name: Ensure public directory exists (if script writes there)
        run: mkdir -p public

      - name: Check if Notion database was updated
        id: check_updates
        env:
          NOTION_API_KEY: ${{ secrets.NOTION_API_KEY }}
          NOTION_EVENTS_DATABASE: ${{ secrets.NOTION_EVENTS_DATABASE }}
        run: |
          if node scripts/check-notion-updates.mjs; then
            echo "fetch_needed=true" >> $GITHUB_OUTPUT
          else
            echo "fetch_needed=false" >> $GITHUB_OUTPUT
          fi
        continue-on-error: true

      - name: Fetch events from Notion
        if: steps.check_updates.outputs.fetch_needed == 'true'
        env:
          NOTION_API_KEY: ${{ secrets.NOTION_API_KEY }}
          NOTION_EVENTS_DATABASE: ${{ secrets.NOTION_EVENTS_DATABASE }}
          NOTION_PLACES_DATABASE: ${{ secrets.NOTION_PLACES_DATABASE }}
        run: node scripts/fetch-events-from-notion.mjs

      - name: Commit & push if changed
        run: |
          # Check if there are any changes
          if [ -z "$(git status --porcelain)" ]; then
            echo "No changes to commit."
            exit 0
          fi
          
          # Check if only .last-sync changed (no actual data changes)
          CHANGED_FILES=$(git status --porcelain | awk '{print $2}')
          ONLY_SYNC_FILE=true
          for file in $CHANGED_FILES; do
            if [ "$file" != ".last-sync" ]; then
              ONLY_SYNC_FILE=false
              break
            fi
          done
          
          if [ "$ONLY_SYNC_FILE" = true ]; then
            echo "Only .last-sync changed, committing timestamp update..."
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git add .last-sync
            git commit -m "chore(sync): update last sync timestamp"
            git push
          else
            echo "Data changes detected, committing updates..."
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git add -A
            git commit -m "chore(data): update events from Notion"
            git push
          fi

